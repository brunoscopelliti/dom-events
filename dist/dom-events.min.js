/**
 * @fileoverview JavaScript DOM event handler micro library.
 * @copyright Bruno Scopelliti 2015
 * @author Bruno Scopelliti <me@brunoscopelliti.com>
 * @license MIT
 *
 * @module src/dom-events
 */
"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function toArray_(a){return null==a?[]:isWindow_(a)||"undefined"==typeof a.length||"FORM"==a.tagName?[a]:Array.from(a)}function isWindow_(a){return a===window}function isEventObject_(a){return/Event]$/.test(Object.prototype.toString.call(a))}function contains_(a,b,c){if("string"==typeof b){var d=c?a:a.parentNode||document;return d.querySelectorAll(b).length>0}return(!c||a!==b)&&a.contains(b)}function getAllEventTypes_(a){var b=Store.get(a),c=new Set(Object.keys(b));return loopProps_(b,function(a,b){a.filter(function(a){return a.origType!=b}).forEach(function(a){return c.add(a.origType)})}),[].concat(_toConsumableArray(c))}function loopProps_(a,b){var c=arguments.length<=2||void 0===arguments[2]?this:arguments[2];for(var d in a)if(Object.prototype.hasOwnProperty.call(a,d)&&b.call(c,a[d],d,a)===!1)return!1;return!0}Object.defineProperty(exports,"__esModule",{value:!0});var match_=function(a){var b=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.msMatchesSelector||a.oMatchesSelector;return function(a,c){return isWindow_(a)?"window"==c:a==document?"document"==c:b.call(a,c)}}(document.body),Store=function(){function a(a,b,c){void 0===b&&(b="");var d=w.get(a);if("undefined"==typeof d)return[];if(!b)return d;if(!c)return d[b]||[];var e=new Set(d[b]);return loopProps_(d,function(a,c){a.filter(function(a){return a.origType==b&&a.origType!=c}).forEach(function(a){return e.add(a)})}),[].concat(_toConsumableArray(e))}function b(a,b,c,d){var f=e(b,c,d);a=g(f.origType,f.delegate)||a,w.has(a)||w.set(a,{}),w.get(a)[f.type]||(w.get(a)[f.type]=[]);var h=w.get(a)[f.type].push(f);return 1==h&&(f.type==f.origType||"undefined"==typeof u[b].setup?k(a,f.type):"function"==typeof u[b].setup&&u[b].setup()),f}function c(a,b,c,d){a=g(b,!0)||a;var e=w.get(a);if(e){var h={origType:b};c&&(h.delegator=c),"function"==typeof d&&(h.handler=d);var k=f(b,!0),m=new Set([b,k]);m.forEach(function(c){e[c]&&(e[c]=i(e[c],j.bind(null,h)),("undefined"==typeof e[c]||0==e[c].length)&&(delete e[c],b==k||"undefined"==typeof u[b].teardown?l(a,c):"function"==typeof u[b].teardown&&u[b].teardown()))})}}function d(a,b,c){var d=!0,e={currentTarget:a,data:c,isFired:!0,target:a,type:b},f=h(a);f.every(function(a){e.currentTarget=a;var b=m(e),c=b.isPropagationStopped,f=b.isDefaultPrevented;return f&&(d=!1),!c}),d&&!isWindow_(a)&&"function"==typeof a[e.type]&&(v=e.type,a[e.type](),v="")}function e(a,b,c){var d=++r,e=null!=b,g=f(a,e),h=Object.create(null);return h[s]=d,h.delegate=e,h.delegator=b,h.origType=a,h.type=g,h.handler=function(a){return c.apply(this,[a].concat(_toConsumableArray(a.data)))},c[s]?h.handler[s]=c[s]:c[s]=h.handler[s]=d,a!=g&&u[a]&&"function"==typeof u[a].decorator&&(h.handler=u[a].decorator(c,h)),h}function f(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return b&&"undefined"!=typeof u[a]?u[a].delegateEvent:a}function g(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return b&&"undefined"!=typeof u[a]?u[a].boundElement||null:null}function h(a){var b=[];do b.push(a);while(a=a.parentNode);return b[b.length-1]===document&&b.push(window),b}function i(a,b){var c=this;return a.filter(function(a,d,e){return!b.call(c,a,d,e)})}function j(a,b){return loopProps_(a,function(a,c){return"function"==typeof a?b[c][s]===a[s]:b[c]===a})}function k(a,b){a.addEventListener(b,m,!1)}function l(a,b){a.removeEventListener(b,m,!1)}function m(a){if(n(a.type))return!1;var b=o(a),c=Store.get(b.currentTarget,b.type,b.isFired);return p(b.target,b.currentTarget,function(a){return a.disabled&&"click"==b.type?void 0:(c.forEach(function(c){!c.delegate||c.delegate&&!contains_(a,c.delegator)||match_(a,c.delegator)&&(c.currentTarget=a,q.call(b,c),delete c.currentTarget)}),!b.isPropagationStopped)}),b.isPropagationStopped?{isPropagationStopped:!0,isDefaultPrevented:b.isDefaultPrevented}:(b.currentTarget.disabled&&"click"==b.type||c.filter(function(a){return!a.delegate}).forEach(q,b),{isPropagationStopped:b.isPropagationStopped,isDefaultPrevented:b.isDefaultPrevented})}function n(a){return v==a||f(v,!0)==a}function o(a){var b=Object.create(t);return b.data=a.data||[],b.isFired=a.isFired||!1,b.currentTarget=a.currentTarget,b.relatedTarget=a.relatedTarget,b.target=a.target,b.type=a.type,isEventObject_(a)&&(b.originalEvent=a),b}function p(a,b,c){if("function"==typeof b){var d=[b,window];c=d[0],b=d[1]}var e=a,f=!0;do f=c.call(e,e);while(f!==!1&&e!=b&&(e=e.parentNode))}function q(a){var b=a.currentTarget||this.currentTarget;a.handler.call(b,this)===!1&&(this.stopPropagation(),this.preventDefault())}var r=0,s=Symbol("EVStore_guid"),t=Object.create(null,{stopPropagation:{value:function(){this.isPropagationStopped=!0,this.originalEvent&&this.originalEvent.stopPropagation()}},preventDefault:{value:function(){this.isDefaultPrevented=!0,this.originalEvent&&this.originalEvent.preventDefault()}}}),u=function(){var a={};return loopProps_({mouseenter:"mouseover",mouseleave:"mouseout"},function(b,c){a[c]={delegateEvent:b,decorator:function(a,b){return function(c){var d=c.target,e=c.relatedTarget;return!match_(d,b.delegator)||e&&contains_(d,e,!0)?void 0:a.apply(d,[c].concat(_toConsumableArray(c.data)))}}}}),loopProps_({focus:"focusin",blur:"focusout"},function(b,c){function d(a){Store.run(a.target,b)}a[c]={boundElement:document,delegateEvent:b,setup:function(){this.boundElement.addEventListener(c,d,!0)},teardown:function(){this.boundElement.removeEventListener(c,d,!0)}}}),a}(),v="",w=new WeakMap;return{get:a,add:b,del:c,run:d}}(),DOMEvents={debug:Store.get,on:function(a,b,c,d){var e=toArray_(a);if("undefined"==typeof d){var f=[c,d];d=f[0],c=f[1]}e.forEach(function(a){Store.add(a,b,c,d)})},off:function(a,b,c,d){var e=toArray_(a);if("undefined"==typeof d&&"function"==typeof c){var f=[c,d];d=f[0],c=f[1]}e.forEach(function(a){var e=null==b?getAllEventTypes_(a):[b];e.forEach(function(b){return Store.del(a,b,c,d)})})},fire:function(a,b){for(var c=arguments.length,d=Array(c>2?c-2:0),e=2;c>e;e++)d[e-2]=arguments[e];var f=toArray_(a);f.forEach(function(a){Store.run(a,b,d)})}};exports["default"]=DOMEvents,exports.EventsStore=Store;